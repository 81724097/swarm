'use strict'

describe 'Service: session', ->

  # load the service's module
  beforeEach module 'swarmApp'

  # instantiate service
  session = {}
  beforeEach inject (_session_) ->
    session = _session_

  it 'should do something', ->
    expect(!!session).toBe true

  it 'saves/loads', ->
    # tests are too quick, and I don't wanna bother with DI'ing date right now
    origsaved = session.date.saved = new Date session.date.saved.getTime() - 1
    state = session._saves()
    expect(origsaved).not.toEqual session.date.saved

    # session is nonequal because of its class/ctor, so use an object for later compares
    orig = _.clone session
    loaded = session._loads state
    expect(orig.date.loaded).not.toEqual loaded.date.loaded
    delete orig.date.loaded
    delete loaded.date.loaded
    expect(orig).toEqual loaded

  it 'saves/loads versionless', ->
    encoded = session._saves()
    [version, encoded] = session._splitVersionHeader encoded
    expect(encoded.indexOf '|').toBeLessThan 0
    data = session._loads encoded
    expect(!!data).toBe true

  it 'saves/loads versionful', ->
    encoded = session._saves()
    expect(encoded.indexOf '|').not.toBeLessThan 0
    data = session._loads encoded
    expect(!!data).toBe true

  it 'validates the save version programmatically', ->
    expect(-> session._validateSaveVersion '0.1.0', '0.1.0').not.toThrow()
    expect(-> session._validateSaveVersion '0.1.0', '0.1.30').not.toThrow()
    # we're allowing older version imports
    expect(-> session._validateSaveVersion '0.1.30', '0.1.0').not.toThrow()
    # but beta minor versions are a reset
    expect(-> session._validateSaveVersion '0.1.30', '0.2.0').toThrow()
    expect(-> session._validateSaveVersion '0.2.30', '0.3.0').toThrow()
    # no importing 0.2.0 games into 0.1.0 either
    expect(-> session._validateSaveVersion '0.2.0', '0.1.30').toThrow()
    expect(-> session._validateSaveVersion '0.3.0', '0.2.30').toThrow()

    expect(-> session._validateSaveVersion '0.2.30', '0.2.0').not.toThrow()
    expect(-> session._validateSaveVersion '0.2.0', '0.2.0').not.toThrow()
    expect(-> session._validateSaveVersion '1.0.0', '1.0.0').not.toThrow()
    # 0.x to 1.0 is not a reset, but no reverse-imports, and 0.1.x's still blacklisted
    expect(-> session._validateSaveVersion '0.9.0', '1.0.0').not.toThrow()
    expect(-> session._validateSaveVersion '1.0.0', '0.9.0').toThrow()
    expect(-> session._validateSaveVersion '0.1.0', '1.0.0').toThrow()
    expect(-> session._validateSaveVersion '1.9.0', '1.0.0').not.toThrow()
    expect(-> session._validateSaveVersion '1.0.0', '1.9.0').not.toThrow()
    # major versions after 1.0 aren't resets
    expect(-> session._validateSaveVersion '2.0.0', '1.0.0').not.toThrow()
    expect(-> session._validateSaveVersion '1.0.0', '2.0.0').not.toThrow()
    # default version - very old saves.
    expect(-> session._validateSaveVersion undefined, '0.1.0').not.toThrow()
    expect(-> session._validateSaveVersion undefined, '0.2.0').toThrow()
    # current-version based. Breaks when upgrading versions.
    expect(-> session._validateSaveVersion '0.1.0').toThrow()
    expect(-> session._validateSaveVersion '0.2.0').not.toThrow()
    expect(-> session._validateSaveVersion '1.0.0').not.toThrow()
    expect(-> session._validateSaveVersion undefined).toThrow()
    expect(-> session._validateSaveVersion '1.0.0-publictest1').toThrow()
    expect(-> session._validateSaveVersion '1.0.0-publictest8').toThrow()
    expect(-> session._validateSaveVersion '1.0.0-publictest20').toThrow()

  it 'validates the save version on import', inject (version) ->
    session.version.started = '0.0.1'
    encoded = session._saves()
    expect(-> session._loads encoded).toThrow()
    session.version.started = '1.0.0'
    encoded = session._saves()
    expect(-> session._loads encoded).not.toThrow()
    session.version.started = version
    encoded = session._saves()
    expect(-> session._loads encoded).not.toThrow()
    # missing version is assumed to be 0.1.0, but we're past 0.2.0 now
    delete session.version
    encoded = session._saves()
    expect(-> session._loads encoded).toThrow()

  it 'validates the format version on import, blocking all publictest imports', inject (version) ->
    v02 = 'MC4yLjIy|Q2hlYXRlciA6KAoKN4IglgJiBcIG4AYB0AmEAaEALApgQwCcAXAI3yIEkpZFVpdDTyMQBXAOzCKIE8AHHAGcYoMOzhhBYEgBscWPEQDGuAjxggAjCwC2zWCgCsAZhSmkhgOzbMMwnDwbNAFgCcbpADZDzlkoD2Af7sGggsRDgEBFz+aqEsOOyRAObqsGGYBEICSgCiSQSp8ZhJAB6swum6rER4yYnFIHxZOjV1DVWYeIJKiVLBjQBmWTgAStk4Shq+mBAEwThOliwAjqw4HSAZIEmCRI3JWYqRaxshndhgcIsXWFc4p5vbODrNQpVbLM3+fLj7F8l/BAIO9Gnw8OwiLgBhdwZDoew0LCIVCcMFjGCUQjfMj4Wj2IZGv5rgQdGJqJ9MMTImT2BAkZSQNTSeSMRdmbSIDjGRzyYT2STOZ5GoIAO6EHQyMTJEVEaWREV8SAKi46fyCNYxRoyQIVf6M+Z4FQHMAowRKkEERq9SFgAQgxri82NEFwfysLJWgH+GGMzjJLCkVgy1X+KGNEiKRqtWrwxQqSJpRkxlGR/XbFOQpQ6pLRtqQsUS8UEPh52NEAgVLBllH4Y2q/NEYYPGuQsoVVu1UlJjONvRRqoAX1mxxEID2jBwFJQCE0hgAtAgUPPNJoACoIBDQFAADmgmlcSGMlhQAC0WFkJ8QpxoZ3PF8vVxut7v94fj2eWII8Ndp7OF0uK7rggzjQMeYGeEgLjGOemQ4GAgxgDeBj/g+QEbqB4HGJBS6eLBIDZuqyEgHeAGPsBL57geR4nuew5MnwcrBJUwD0awfCHHgIIsfRE5ynsYBKCxIAkDwACqnD/KAcwLGO2aCQA1pUxglKwOhLOEopiOwakaZgOB2HwghTgAYmABB7DAKDuAgxiDvRoliRxBBcTcrGYPJShKTAdldCoSHXHoBZjnwrCyIJER7No+4oCgmizPMSTRdZzi2R5CjsPUOohtZhieJ4liGLMOAkMGMAuK4eXeM4vEKXa9oALJgDIUqVAgmAkv05ygFeEQUpoSDIGE9lAAAA'
    v1 = 'MS4wLjA=|Q2hlYXRlciA6KAoKN4IglgJiBcIG4AYB0AmEAaEALApgQwCcAXAI3yIEkpZFVpdDTyMQBXAOzCKIE8AHHAGcYoMOzhhBYEgBscWPEQDGuAjxggAjCwC2zWCgCsAZhSmkhgOzbMMwnDwbNAFgCcbpADZDzlkoD2Af7sGggsRDgEBFz+aqEsOOyRAObqsGGYBEICSgCiSQSp8ZhJAB6swum6rER4yYnFIHxZOjV1DVWYeIJKiVLBjQBmWTgAStk4Shq+mBAEwThOliwAjqw4HSAZIEmCRI3JWYqRaxshndhgcIsXWFc4p5vbODrNQpVbLM3+fLj7F8l/BAIO9Gnw8OwiLgBhdwZDoew0LCIVCcMFjGCUQjfMj4Wj2IZGv5rgQdGJqJ9MMTImT2BAkZSQNTSeSMRdmbSIDjGRzyYT2STOZ5GoIAO6EHQyMTJEVEaWREV8SAKi46fyCNYxRoyQIVf6M+Z4FQHMAowRKkEERq9SFgAQgxri82NEFwfysLJWgH+GGMzjJLCkVgy1X+KGNEiKRqtWrwxQqSJpRkxlGR/XbFOQpQ6pLRtqQsUS8UEPh52NEAgVLBllH4Y2q/NEYYPGuQsoVVu1UlJjONvRRqoAX1mxxEID2jBwFJQCE0hgAtAgUPPNJoACoIBDQFAADmgmlcSGMlhQAC0WFkJ8QpxoZ3PF8vVxut7v94fj2eWII8Ndp7OF0uK7rggzjQMeYGeEgLjGOemQ4GAgxgDeBj/g+QEbqB4HGJBS6eLBIDZuqyEgHeAGPsBL57geR4nuew5MnwcrBJUwD0awfCHHgIIsfRE5ynsYBKCxIAkDwACqnD/KAcwLGO2aCQA1pUxglKwOhLOEopiOwakaZgOB2HwghTgAYmABB7DAKDuAgxiDvRoliRxBBcTcrGYPJShKTAdldCoSHXHoBZjnwrCyIJER7No+4oCgmizPMSTRdZzi2R5CjsPUOohtZhieJ4liGLMOAkMGMAuK4eXeM4vEKXa9oALJgDIUqVAgmAkv05ygFeEQUpoSDIGE9lAAAA'
    publictestImported = 'MS4wLjAtcHVibGljdGVzdDI3|Q2hlYXRlciA6KAoKN4IglgJiBcIG4AYB0AmEAaEALApgQwCcAXAI3yIEkpZFVpdDTyMQBXAOzCKIE8AHHAGcYoMOzhhBYEgBscWPEQDGuAjxggAjCwC2zWCgCsAZhSmkhgOzbMMwnDwbNAFgCcbpADZDzlkoD2Af7sGggsRDgEBFz+aqEsOOyRAObqsGGYBEICSgCiSQSp8ZhJAB6swum6rER4yYnFIHxZOjV1DVWYeIJKiVLBjQBmWTgAStk4Shq+mBAEwThOliwAjqw4HSAZIEmCRI3JWYqRaxshndhgcIsXWFc4p5vbODrNQpVbLM3+fLj7F8l/BAIO9Gnw8OwiLgBhdwZDoew0LCIVCcMFjGCUQjfMj4Wj2IZGv5rgQdGJqJ9MMTImT2BAkZSQNTSeSMRdmbSIDjGRzyYT2STOZ5GoIAO6EHQyMTJEVEaWREV8SAKi46fyCNYxRoyQIVf6M+Z4FQHMAowRKkEERq9SFgAQgxri82NEFwfysLJWgH+GGMzjJLCkVgy1X+KGNEiKRqtWrwxQqSJpRkxlGR/XbFOQpQ6pLRtqQsUS8UEPh52NEAgVLBllH4Y2q/NEYYPGuQsoVVu1UlJjONvRRqoAX1mxxEID2jBwFJQCE0hgAtAgUPPNJoACoIBDQFAADmgmlcSGMlhQAC0WFkJ8QpxoZ3PF8vVxut7v94fj2eWII8Ndp7OF0uK7rggzjQMeYGeEgLjGOemQ4GAgxgDeBj/g+QEbqB4HGJBS6eLBIDZuqyEgHeAGPsBL57geR4nuew5MnwcrBJUwD0awfCHHgIIsfRE5ynsYBKCxIAkDwACqnD/KAcwLGO2aCQA1pUxglKwOhLOEopiOwakaZgOB2HwghTgAYmABB7DAKDuAgxiDvRoliRxBBcTcrGYPJShKTAdldCoSHXHoBZjnwrCyIJER7No+4oCgmizPMSTRdZzi2R5CjsPUOohtZhieJ4liGLMOAkMGMAuK4eXeM4vEKXa9oALJgDIUqVAgmAkv05ygFeEQUpoSDIGE9lAAAA'
    publictestCreated = 'MS4wLjAtcHVibGljdGVzdDI3|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'
    publictestBroken = 'MS4wLjAtcHVibGljdGVzdDI2|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'
    expect(->session._loads v02).not.toThrow()
    expect(->session._loads v1).not.toThrow()
    expect(->session._loads publictestCreated).toThrow()
    expect(->session._loads publictestImported).toThrow()
    expect(->session._loads publictestBroken).toThrow()
